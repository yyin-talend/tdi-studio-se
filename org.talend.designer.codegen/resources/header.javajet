<%@ jet 
	package="org.talend.designer.codegen.translators" 
	imports="
		org.talend.core.model.process.IProcess
		org.talend.core.model.process.INode
		org.talend.core.model.process.IConnection 
		org.talend.core.model.process.EConnectionType
		org.talend.core.model.process.ElementParameterParser
		org.talend.designer.codegen.config.CodeGeneratorArgument
		org.talend.designer.runprocess.CodeGeneratorRoutine
		org.talend.designer.codegen.i18n.Messages
		org.talend.core.ui.branding.IBrandingService
		org.talend.core.ui.branding.AbstractBrandingService
		org.talend.core.GlobalServiceRegister
		org.talend.designer.codegen.ITalendSynchronizer
		java.util.List
		java.util.ArrayList
		java.util.Vector
		org.talend.core.model.process.IContextParameter
		org.talend.core.model.metadata.types.JavaTypesManager
		org.talend.core.model.utils.NodeUtil
		org.talend.core.model.utils.JavaResourcesHelper
	"
	class="Header" 
%>
<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;
    Vector v = (Vector) codeGenArgument.getArgument();
	IProcess process = (IProcess)v.get(0);
    String version = (String)v.get(1);  
	
	List< ? extends INode> processNodes = (List< ? extends INode>)process.getGeneratingNodes();
	boolean stats = codeGenArgument.isStatistics();
	boolean trace = codeGenArgument.isTrace();
	boolean isRunInMultiThread = codeGenArgument.getIsRunInMultiThread();
	List<IContextParameter> params = new ArrayList<IContextParameter>();
	params=process.getContextManager().getDefaultContext().getContextParameterList();
%>
<%
IBrandingService service=(IBrandingService)GlobalServiceRegister.getDefault().getService(IBrandingService.class);
if(service instanceof AbstractBrandingService){
 %>
 <%=((AbstractBrandingService) service).getJobLicenseHeader(version)%>
<%
 }
  String jobFolderName = JavaResourcesHelper.getJobFolderName(process.getLabel(), process.getVersion());
  String packageName = codeGenArgument.getCurrentProjectName().toLowerCase() + "." + jobFolderName;
%> 
package <%= packageName %>;

<%for (String routine : CodeGeneratorRoutine.getRequiredRoutineName(process)) {
	if(!routine.equals(ITalendSynchronizer.TEMPLATE)){%>
import routines.<%=routine%>;
<%	}
}%>
import routines.system.*;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.math.BigDecimal;
import java.io.ByteArrayOutputStream;
import java.io.ByteArrayInputStream;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.ObjectOutputStream;
import java.io.ObjectInputStream;
import java.io.IOException;
import java.util.Comparator;

<%=ElementParameterParser.getValue(process, "__HEADER_IMPORT__") %>
<%=ElementParameterParser.getValue(process, "__FOOTER_IMPORT__") %>


<%
	List<INode> nodesWithImport = process.getNodesWithImport();
	if(nodesWithImport != null) {
		for(INode node:nodesWithImport){
%>
	//the import part of <%=node.getUniqueName() %>
	<%=ElementParameterParser.getValue(node, "__IMPORT__") %>
	
<% 		}
    } 
%>

/**
 * Job: <%=process.getName() %> Purpose: <%=ElementParameterParser.getValue(process, "__PURPOSE__") %><br>
 * Description: <%=ElementParameterParser.getValue(process, "__DESCRIPTION__") %> <br>
 * @author <%=ElementParameterParser.getValue(process, "__AUTHOR__") %>
 * @version <%=version %>
 * @status <%=ElementParameterParser.getValue(process, "__STATUS__") %> 
 */                                
 public class <%=process.getName()%> {
 	
 	public final Object obj = new Object();
 	
 	//for transmiting parameters purpose
    private Object valueObject = null;
    
    public Object getValueObject() {
    	return this.valueObject;
    }
    
    public void setValueObject(Object valueObject) {
    	this.valueObject = valueObject;
    }
<%
if(isRunInMultiThread){
%>
 	private Object[] multiThreadLockWrite = new Object[0];
<%
}
%>
	<%//it will be use in job setting.%>    
    private final static String defaultCharset = java.nio.charset.Charset.defaultCharset().name();
    
    <%//uft-8 is for temp file, for example: tSortRow, tMap. Because they need keep reversibility.%>
    private final static String utf8Charset = "UTF-8";
    
    // create and load default properties
	private java.util.Properties defaultProps = new java.util.Properties();
	// create application properties with default
	public class ContextProperties extends java.util.Properties {
	    
	    public ContextProperties(java.util.Properties properties){
	        super(properties);
	    }
	    public ContextProperties(){
	        super();
	    }
	    
		public void synchronizeContext(){
			<% for (IContextParameter ctxParam :params){
			 	String cParaName = ctxParam.getName(); 	
			%>
			if(<%=cParaName %> != null){				
				<%if(ctxParam.getType().equals("id_Date")){%>
					String pattern_<%=cParaName %> = "yyyy-MM-dd HH:mm:ss";
					String value_<%=cParaName %> = "<%=ctxParam.getValue() %>";
					String[] parts_<%=cParaName %> = value_<%=cParaName %>.split(";");					 
					if(parts_<%=cParaName %>.length > 1){
						pattern_<%=cParaName %> = parts_<%=cParaName %>[0];
						this.setProperty("<%=cParaName %>", pattern_<%=cParaName %> + ";" + FormatterUtils.format_Date(<%=cParaName %>, pattern_<%=cParaName %>));
					}else{
						this.setProperty("<%=cParaName %>", FormatterUtils.format_Date(<%=cParaName %>, pattern_<%=cParaName %>));					
					}					
				<%}else{%>
					this.setProperty("<%=cParaName %>", <%=cParaName %>.toString());
				<%}%>					
			}
			<% } %>
		}
			    
<%
    for (IContextParameter ctxParam :params)
     {
        if(ctxParam.getType().equals("id_List Of Value") || ctxParam.getType().equals("id_File") || ctxParam.getType().equals("id_Directory"))
        {
     %>
     public  String <%=ctxParam.getName()%>;
     public String get<%=Character.toUpperCase(ctxParam.getName().charAt(0)) + ctxParam.getName().substring(1)%>(){
     	return this.<%=ctxParam.getName()%>;
     }
     <%
        }else
        {
%>      
 public  <%=JavaTypesManager.getTypeToGenerate(ctxParam.getType(),true)%>  <%=ctxParam.getName()%>;
 public <%=JavaTypesManager.getTypeToGenerate(ctxParam.getType(),true)%> get<%=Character.toUpperCase(ctxParam.getName().charAt(0)) + ctxParam.getName().substring(1)%>(){
 	return this.<%=ctxParam.getName()%>;
 }
  <%    }
     }
%>
	}	
	private ContextProperties context = new ContextProperties();
	public ContextProperties getContext() {
		return this.context;
	}	
	private final String jobVersion = "<%=process.getVersion() %>";
	private final String jobName = "<%=codeGenArgument.getJobName() %>";
	private final String projectName = "<%=codeGenArgument.getCurrentProjectName() %>";
	public Integer errorCode = null;
<%
	if(!isRunInMultiThread ){
%>
	private String currentComponent = "";
	private final java.util.Map<String, Long> start_Hash = new java.util.HashMap<String, Long>(); 
	private final java.util.Map<String, Long> end_Hash = new java.util.HashMap<String, Long>();
	private final java.util.Map<String, Boolean> ok_Hash = new java.util.HashMap<String, Boolean>();
	private final java.util.Map<String, Object> globalMap = new java.util.HashMap<String, Object>();	
	public  final java.util.List<String[]> globalBuffer = new java.util.ArrayList<String[]>();
<%
	}else {
%>
	private final java.util.Map<String, Long> start_Hash = java.util.Collections.synchronizedMap(new java.util.HashMap<String, Long>());
	private final java.util.Map<String, Long> end_Hash = java.util.Collections.synchronizedMap(new java.util.HashMap<String, Long>());
	private final java.util.Map<String, Boolean> ok_Hash = java.util.Collections.synchronizedMap(new java.util.HashMap<String, Boolean>());	
	private final java.util.Map<String, Object> globalMap = java.util.Collections.synchronizedMap(new java.util.HashMap<String, Object>());
	public  final java.util.List<String[]> globalBuffer = java.util.Collections.synchronizedList(new java.util.ArrayList<String[]>());
<% } %>

<%
    if (stats) {
%>
private RunStat runStat = new RunStat();
<%
    }
%>
<%
    if (trace) {
%>
private RunTrace runTrace = new RunTrace();
<%
    }
%>

<% 
	for (INode logCatcher : process.getNodesOfType("tLogCatcher")) {
%>
	LogCatcherUtils <%=logCatcher.getUniqueName() %> = new LogCatcherUtils(); 
<%
	}

	for (INode statCatcher : process.getNodesOfType("tStatCatcher")) {
%>
	StatCatcherUtils <%=statCatcher.getUniqueName() %> = new StatCatcherUtils("<%=process.getId() %>", "<%=process.getVersion() %>"); 
<%
	}
	
	for (INode metterCatcher : process.getNodesOfType("tFlowMeterCatcher")) {
%>
	MetterCatcherUtils <%=metterCatcher.getUniqueName() %> = new MetterCatcherUtils("<%=process.getId() %>", "<%=process.getVersion() %>"); 
<%
	}
	
	for (INode assertCatcher : process.getNodesOfType("tAssertCatcher")) {
%>
	AssertCatcherUtils <%=assertCatcher.getUniqueName() %> = new AssertCatcherUtils(); 
<%
	}
%>

private final java.io.ByteArrayOutputStream baos = new java.io.ByteArrayOutputStream();
private final java.io.PrintStream errorMessagePS = new java.io.PrintStream(new java.io.BufferedOutputStream(baos));

public String getExceptionStackTrace() {
	if ("failure".equals(this.getStatus())) {
		errorMessagePS.flush();
		return baos.toString();
	}
	return null;
}

private Exception exception = null;

public Exception getException() {
	if ("failure".equals(this.getStatus())) {			
		return this.exception;
	}
	return null;
}

private class TalendException extends Exception {
	private java.util.Map<String, Object> globalMap = null;
	private Exception e = null;
	private String currentComponent = null;
	
	private TalendException(Exception e, String errorComponent, final java.util.Map<String, Object> globalMap) {
		this.currentComponent= errorComponent;
		this.globalMap = globalMap;
		this.e = e;
	}
	
	@Override
	public void printStackTrace() {
	    if (!(e instanceof TalendException || e instanceof TDieException)) {
	     	globalMap.put(currentComponent+"_ERROR_MESSAGE",e.getMessage());
	        System.err.println("Exception in component " + currentComponent);
	    }
	    if (!(e instanceof TDieException)) {
			if(e instanceof TalendException){
				e.printStackTrace();	
			}else{
				e.printStackTrace();
				e.printStackTrace(errorMessagePS);
				<%=process.getName() %>.this.exception = e; 
			}
	    }
		if (!(e instanceof TalendException)) {
		try {
			for (java.lang.reflect.Method m : this.getClass().getEnclosingClass().getMethods()) {
				if (m.getName().compareTo(currentComponent + "_error") == 0) {
					m.invoke(<%=process.getName() %>.this, new Object[] { e , currentComponent, globalMap});
					break;
				}
			}
			
			if(!(e instanceof TDieException)){
<%
		if (process.getNodesOfType("tLogCatcher").size() > 0) {
			List<INode> logCatchers = (List<INode>)process.getNodesOfType("tLogCatcher");
			for (INode logCatcher : logCatchers) {
				if (ElementParameterParser.getValue(logCatcher, "__CATCH_JAVA_EXCEPTION__").equals("true")) {
					// 1) add the message to the stack
%>
            <%=logCatcher.getUniqueName() %>.addMessage("Java Exception", currentComponent, 6, e.getClass().getName() + ":" + e.getMessage(), 1);
<%
				}
			}
			
			INode virtualNCatchNode = null;
			boolean hasRealCatchNode = false; 
			for (INode logCatcher : logCatchers) {
				if (ElementParameterParser.getValue(logCatcher, "__CATCH_JAVA_EXCEPTION__").equals("true")) {
					if(logCatcher.isVirtualGenerateNode()){
						virtualNCatchNode = logCatcher;
					}else{
						hasRealCatchNode = true;
					}
				}
			}
			if(hasRealCatchNode && virtualNCatchNode!=null){
%>
			try{
<%
			}
			for (INode logCatcher : logCatchers) {
				if (ElementParameterParser.getValue(logCatcher, "__CATCH_JAVA_EXCEPTION__").equals("true")) {
					if(logCatcher!=virtualNCatchNode){
					// 2) launch logCatcher subProcess
%>
				<%=logCatcher.getDesignSubjobStartNode().getUniqueName() %>Process(globalMap);
<%
					}
				}
			}
			if(hasRealCatchNode && virtualNCatchNode!=null){
%>
			}finally{
<%
			}
			if(virtualNCatchNode!=null){
%>
				<%=virtualNCatchNode.getDesignSubjobStartNode().getUniqueName() %>Process(globalMap);
<%
			}
			if(hasRealCatchNode && virtualNCatchNode!=null){
%>
			}
<%
			}
		}
%>
			}
		} catch (java.lang.SecurityException e) {
			this.e.printStackTrace();
		} catch (java.lang.IllegalArgumentException e) {
			this.e.printStackTrace();
		} catch (java.lang.IllegalAccessException e) {
			this.e.printStackTrace();
		} catch (java.lang.reflect.InvocationTargetException e) {
			this.e.printStackTrace();
		}
<% 		
		boolean needCatchTalendException = false;
		if (process.getNodesOfType("tLogCatcher").size() > 0) {
			for(INode node:process.getNodesOfType("tLogCatcher")){ 
				if(ElementParameterParser.getValue(node, "__CATCH_JAVA_EXCEPTION__").equals("true")){
				needCatchTalendException = true; 
				break;
				} 
			} 
		}
		
		if ((!needCatchTalendException) && (process.getNodesOfType("tAssertCatcher").size() > 0)) {
			for(INode node:process.getNodesOfType("tAssertCatcher")){ 
				if(ElementParameterParser.getValue(node, "__CATCH_JAVA_EXCEPTION__").equals("true")){
				needCatchTalendException = true; 
				break;
				} 
			} 
		}
		if(needCatchTalendException) {
		    if (process.getNodesOfType("tLogCatcher").size() > 0) {
		        %>
		        catch (TalendException e) {
		            // do nothing
		        }
		        <%
		    }
		}
		%>
		}
	}
}

<% // Methods for RUN IF Error links %>
<%
	for (INode node : processNodes) {
		if (node.isActivate()) {
		    %>
            public void <%=node.getUniqueName() %>_error(Exception exception, String errorComponent, final java.util.Map<String, Object> globalMap) throws TalendException {
                end_Hash.put("<%=node.getUniqueName() %>", System.currentTimeMillis());
                <%
                boolean ifBeforRunError = NodeUtil.checkComponentErrorConnectionAfterNode(node);
                if(!ifBeforRunError) {
                    if (process.getNodesOfType("tAssertCatcher").size() > 0) {
                        List<INode> assertCatchers = (List<INode>)process.getNodesOfType("tAssertCatcher");
                        for (INode assertCatcher : assertCatchers) {
                            if (ElementParameterParser.getValue(assertCatcher, "__CATCH_JAVA_EXCEPTION__").equals("true")) {
                                // 1) add the message to the stack
                                %>
                                if(!(exception instanceof TDieException)){
                                    <%=assertCatcher.getUniqueName()%>.addMessage(pid, projectName, jobName, "java", null, "Failed", "Job execution error", exception.getMessage());
                                    <%=assertCatcher.getDesignSubjobStartNode().getUniqueName() %>Process(globalMap);
                                }
                                <%
                            }
                        }
                    }
                }                
                if (!node.getComponent().getName().equals("tDie")) {
                    String statCatcher = ElementParameterParser.getValue(node,"__TSTATCATCHER_STATS__");
                	if (statCatcher.compareTo("true")==0) {
                		for (INode statCatcherNode : node.getProcess().getNodesOfType("tStatCatcher")) {
                		    %>
                		    <%=statCatcherNode.getUniqueName() %>.addMessage("failure","<%=node.getUniqueName() %>", end_Hash.get("<%=node.getUniqueName() %>")-start_Hash.get("<%=node.getUniqueName() %>"));
                		    <%=statCatcherNode.getDesignSubjobStartNode().getUniqueName() %>Process(globalMap);
                		    <%
                		}
                	}
                }
                List< ? extends IConnection> conns = node.getOutgoingConnections();
                for (IConnection conn : conns) {
                    if (conn.getLineStyle().equals(EConnectionType.ON_COMPONENT_ERROR)) {
                        %>
                        try {	    
	
                            <%
                            if(isRunInMultiThread ){
                                %>
                                ((java.util.Map)threadLocal.get()).put("errorCode", null); 
                                <%=conn.getTarget().getUniqueName() %>Process(globalMap);
                                ((java.util.Map)threadLocal.get()).put("status", "end");
                                <%
                            }else {
                                %>
                                errorCode = null;
                                <%=conn.getTarget().getUniqueName() %>Process(globalMap);
                                status="end";
                                <%
                            }
                            %>
    	
    	
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                        <%
                    }
                }
                // when use parallelize will add virtual components(tAsyncIn and tAsyncOut) but in graphical these is visable=false
                if ("true".equals(ElementParameterParser.getValue(node, "__PARALLELIZE__"))) {
                	for (INode gNode :node.getProcess().getGraphicalNodes()) {
                		if (gNode.getUniqueName().equals(node.getUniqueName())) {
                			if (gNode.getIncomingConnections(EConnectionType.FLOW_MAIN).size()!= 0) {
                				INode gSourceNode = gNode.getIncomingConnections(EConnectionType.FLOW_MAIN).get(0).getSource();
                				node = gSourceNode;
                			}
                		}
                	}
                }
                //end 
                %>
                <%=node.getDesignSubjobStartNode().getUniqueName() %>_onSubJobError(exception, errorComponent, globalMap);

            }
            <%
		}
	}
	for (INode node : processNodes) {
		if (node.isDesignSubjobStartNode()) {
%>
			public void <%=node.getUniqueName() %>_onSubJobError(Exception exception, String errorComponent, final java.util.Map<String, Object> globalMap) throws TalendException {
<%
			List< ? extends IConnection> conns = node.getOutgoingConnections();
			int count = 0;
			for (IConnection conn : conns) {
				if (conn.getLineStyle().equals(EConnectionType.ON_SUBJOB_ERROR)) {
					count++;
				}
			}				
			
			String label = "ERROR";
			
			if(count == 0){//FATAL
				label = "FATAL";
			}else{//ERROR------>RunSubJobError 
				label = "ERROR";
			}
%>

resumeUtil.addLog("SYSTEM_LOG", "NODE:"+ errorComponent, "", Thread.currentThread().getId()+ "", "<%=label %>", "", exception.getMessage(), ResumeUtil.getExceptionStackTrace(exception),"");

<%			
			for (IConnection conn : conns) {
				if (conn.getLineStyle().equals(EConnectionType.ON_SUBJOB_ERROR)) {
%>
				try {	    
<%
					if(isRunInMultiThread ){
%>
					((java.util.Map)threadLocal.get()).put("errorCode", null); 
					<%=conn.getTarget().getUniqueName() %>Process(globalMap);
					((java.util.Map)threadLocal.get()).put("status", "end");
<%
					} else {
%>
					errorCode = null;
					<%=conn.getTarget().getUniqueName() %>Process(globalMap);
					status="end";
<%
					}
%>
				} catch (Exception e) {
					e.printStackTrace();
				}
<%
				}
			}
%>
			}
<%
		}
	}
%>
