<%@ jet 
	imports="
		org.talend.core.model.process.INode
		org.talend.designer.codegen.config.CodeGeneratorArgument
		org.talend.core.model.process.ElementParameterParser
		"
%>	
<%
	CodeGeneratorArgument codeGenArgument = (CodeGeneratorArgument) argument;

	INode node = (INode)codeGenArgument.getArgument();

	String cid = node.getUniqueName();

	String fileName = ElementParameterParser.getValue(node, "__FILENAME__");	

	String destination  = ElementParameterParser.getValue(node, "__DESTINATION__");
	
	boolean rename = ("true").equals(ElementParameterParser.getValue(node, "__RENAME__"));
	
	String destination_filename  = ElementParameterParser.getValue(node, "__DESTINATION_RENAME__");

	boolean isCopyADir = ("true").equals(ElementParameterParser.getValue(node, "__ENABLE_COPY_DIRECTORY__"));
	
	boolean reFile = ("true").equals(ElementParameterParser.getValue(node, "__REMOVE_FILE__"));

	boolean rpFile = ("true").equals(ElementParameterParser.getValue(node,"__REPLACE_FILE__"));

	boolean creatDir = ("true").equals(ElementParameterParser.getValue(node,"__CREATE_DIRECTORY__"));
	
	if (isCopyADir){ // copy a directory
%>     
		String srcFileFolderPath_<%=cid %> = <%=ElementParameterParser.getValue(node, "__SOURCE_DERECTORY__")%>;

		String desFileFolderPath_<%=cid %> = <%=ElementParameterParser.getValue(node, "__DESTINATION__")%>;

		java.io.File srcFileFolder_<%=cid %> = new java.io.File(srcFileFolderPath_<%=cid %>);

		java.io.File desFileFolder_<%=cid %> = new java.io.File(desFileFolderPath_<%=cid %>);

		int srcFilePathLength_<%=cid %> = srcFileFolder_<%=cid %>.getPath().length();

		String srcFolderName_<%=cid %> = srcFileFolder_<%=cid %>.getName();

		java.io.File newDesFileFolder_<%=cid %> = new java.io.File(desFileFolder_<%=cid %>, srcFolderName_<%=cid %>);
      
		class CopyDirectory_<%=cid %> {		

			public void copyAllFiles(java.io.File rootFolder, int pathLength, java.io.File newDesFileFolder) {

				java.io.File[] fileList = rootFolder.listFiles();

				if (fileList.length > 0) {
				
					for (java.io.File file : fileList) {				

						if (file.isDirectory()) {
							copyAllFiles(file, pathLength, newDesFileFolder);
						} else {
						
							String srcFilePath = file.getPath();

							String temFileName = srcFilePath.substring(pathLength);

							java.io.File desFile = new java.io.File(newDesFileFolder, temFileName);

							String desFilePath = desFile.getPath();

							java.io.File parentFile = desFile.getParentFile();

							if (!parentFile.exists()) {
								parentFile.mkdirs();
							}

							try	{				
								org.talend.FileCopy.copyFile(srcFilePath, desFilePath, false);
							} catch (Exception e){ 				
								e.printStackTrace();
							}
						}

					}
				} else{ //it is an empty folder.        
        
					String srcFolderPath = rootFolder.getPath();

					String temFolderName = srcFolderPath.substring(pathLength);

					java.io.File desFolder = new java.io.File(newDesFileFolder, temFolderName);
					desFolder.mkdirs();     
				} 
        
			}
		}
    
		CopyDirectory_<%=cid %> copyDir_<%=cid %> = new CopyDirectory_<%=cid %>();	  
		copyDir_<%=cid %>.copyAllFiles(srcFileFolder_<%=cid %>, srcFilePathLength_<%=cid %>,newDesFileFolder_<%=cid %>);

		globalMap.put("<%=cid %>_SOURCE_DIRECTORY", srcFileFolderPath_<%=cid %>);
		globalMap.put("<%=cid %>_DESTINATION_DIRECTORY", desFileFolderPath_<%=cid %>);

<% 
	} else { //copy a file
%>

		String srcFileName_<%=cid %> = <%=fileName %>;

		java.io.File srcFile_<%=cid %> = new java.io.File(srcFileName_<%=cid %>);

		// here need check first, before mkdirs().
		if (!srcFile_<%=cid %>.exists() || !srcFile_<%=cid %>.isFile()) {
			throw new RuntimeException("The source File \"" + srcFileName_<%=cid %> + "\" does not exist or is not a file.");
		}

		String desDirName_<%=cid %> = <%=destination %>;

		String desFileName_<%=cid %> = <%if(rename){%> <%=destination_filename %> <%}else{%> srcFile_<%=cid %>.getName() <%}%>;

		if (desFileName_<%=cid %> != null && ("").equals(desFileName_<%=cid %>.trim())){
			desFileName_<%=cid %> = "NewName.temp";
		}

		java.io.File desFile_<%=cid %> = new java.io.File(desDirName_<%=cid %>, desFileName_<%=cid %>);

		if (!srcFile_<%=cid %>.getPath().equals(desFile_<%=cid %>.getPath()) <%if (!rpFile){%> && !desFile_<%=cid %>.exists() <%}%> ) {
<%
			if (creatDir){
%>
				java.io.File parentFile_<%=cid %> = desFile_<%=cid %>.getParentFile();

				if (parentFile_<%=cid %> != null && !parentFile_<%=cid %>.exists()) {
					parentFile_<%=cid %>.mkdirs();
				}
<%
			}
%>           
			org.talend.FileCopy.copyFile(srcFile_<%=cid %>.getPath(), desFile_<%=cid %>.getPath(), <%=reFile %>);
<%
			if(reFile) {
%>
				java.io.File isRemoved_<%=cid %> = new java.io.File(<%=fileName%>);
				if(isRemoved_<%=cid %>.exists()) {
					System.err.println("The source file could not be removed from the folder because it is open or you only have read-only rights.\n");
				}
			
<%			}
%>

		}

        String desFilePath_<%=cid %>=desFile_<%=cid %>.getPath().replaceAll("\\\\", "/");
		globalMap.put("<%=cid %>_DESTINATION_FILEPATH",desFilePath_<%=cid %>);
		globalMap.put("<%=cid %>_DESTINATION_FILENAME",desFile_<%=cid %>.getName());
		String  srcFilePathFolder_<%=cid%>=srcFileName_<%=cid %>.replaceAll("\\\\", "/");
		desDirName_<%=cid %>=desDirName_<%=cid %>.replaceAll("\\\\", "/");
		srcFilePathFolder_<%=cid%>=srcFilePathFolder_<%=cid%>.substring(0,srcFilePathFolder_<%=cid%>.lastIndexOf("/")+1);
		globalMap.put("<%=cid %>_SOURCE_DIRECTORY", srcFilePathFolder_<%=cid %>);
		globalMap.put("<%=cid %>_DESTINATION_DIRECTORY", desDirName_<%=cid %>);
<%
	}
%>        
        
